Option Explicit

' References:
' - Microsoft Scripting Runtime
' - Microsoft XML, v6.0

Private Declare PtrSafe Function SetForegroundWindow Lib "user32" (ByVal hwnd As LongPtr) As Long
Private Declare PtrSafe Function ShowWindow Lib "user32" (ByVal hwnd As LongPtr, ByVal nCmdShow As Long) As Long

Private Const SW_MAXIMIZE As Long = 3

Sub SearchAndClickUsingCDP()
    Dim chromePath As String
    Dim hwnd As LongPtr
    Dim tabID As String
    Dim searchURL As String
    Dim buttonXPath As String

    ' Path to the default Chrome installation
    chromePath = """C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"""
    
    ' Define the search URL and button XPath
    searchURL = "https://your-url-with-the-search-button" ' Use your actual URL here
    buttonXPath = "//input[@type='submit' and @name='btnG']" ' XPath for the search button
    
    ' Launch Chrome with debugging enabled
    Shell chromePath & " --remote-debugging-port=9222 --user-data-dir=""C:\ChromeAutomation"" --start-maximized", vbNormalFocus
    
    ' Wait for Chrome to launch
    Application.Wait Now + TimeValue("00:00:05")
    
    ' Attach to the Chrome DevTools Protocol and open the specified URL
    tabID = OpenNewTab(searchURL)
    
    ' Wait for the page to load
    Application.Wait Now + TimeValue("00:00:05")
    
    ' Use CDP to find and click the search button by XPath
    ClickElementByXPath tabID, buttonXPath
    
    MsgBox "Search button clicked successfully!"
End Sub

' Function to open a new tab and navigate to a URL using CDP
Function OpenNewTab(url As String) As String
    Dim http As Object
    Dim jsonResponse As String
    Dim tabID As String
    
    ' Create a new HTTP request to communicate with Chrome DevTools
    Set http = CreateObject("MSXML2.ServerXMLHTTP.6.0")
    http.Open "POST", "http://localhost:9222/json/new", False
    http.setRequestHeader "Content-Type", "application/json"
    http.send "{""url"":""" & url & """}"
    
    ' Get the response which includes the tab ID
    jsonResponse = http.responseText
    
    ' Extract the tab ID from the JSON response
    tabID = ExtractTabID(jsonResponse)
    
    ' Return the tab ID
    OpenNewTab = tabID
End Function

' Function to click an element using XPath via Chrome DevTools Protocol
Sub ClickElementByXPath(tabID As String, xpath As String)
    Dim http As Object
    Dim command As String
    Dim jsonResponse As String
    
    ' Command to query the element by XPath and click it
    command = "{""id"": 1, ""method"": ""Runtime.evaluate"", ""params"": {""expression"": ""document.evaluate('" & xpath & "', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue.click();""}}"
    
    ' Send the command to Chrome DevTools
    Set http = CreateObject("MSXML2.ServerXMLHTTP.6.0")
    http.Open "POST", "http://localhost:9222/json/" & tabID, False
    http.setRequestHeader "Content-Type", "application/json"
    http.send command
    
    ' Get the response from Chrome DevTools
    jsonResponse = http.responseText
End Sub

' Function to extract tab ID from JSON response
Function ExtractTabID(jsonResponse As String) As String
    Dim startPos As Integer
    Dim endPos As Integer
    
    ' Find the "id" field in the JSON response
    startPos = InStr(jsonResponse, """id"":""") + 6
    endPos = InStr(startPos, jsonResponse, """")
    
    ' Extract the tab ID
    ExtractTabID = Mid(jsonResponse, startPos, endPos - startPos)
End Function
